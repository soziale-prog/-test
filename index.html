<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Записная книжка</title>

  <!-- VK Bridge -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <!-- VKUI -->
  <script src="https://unpkg.com/@vkontakte/vkui@6.0.1/dist/vkui.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@vkontakte/vkui@6.0.1/dist/vkui.css" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, system-ui, sans-serif;
      background: var(--vkui--color_background);
    }

    .vkuiApp {
      max-width: 480px;
      margin: 0 auto;
    }

    .event-actions {
      display: flex;
      gap: 8px;
    }

    .edit-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    input, button {
      font-size: 17px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const { AppRoot, Group, Button, Input, Div, SimpleCell, Panel, PanelHeader, Title } = vkui;

    // === Supabase настройки ===
    const SUPABASE_URL = 'https://inzwlacghhzlzduvvlyb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluendsYWNnaGh6bHpkdXZ2bHliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNzg2NjEsImV4cCI6MjA3Nzc1NDY2MX0.r7H8cHfQfM9_FZiibCa-J6Gt6yGd4p-FCdS2FsFO3C8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;

    async function initVK() {
      await vkBridge.send('VKWebAppInit');
      const user = await vkBridge.send('VKWebAppGetUserInfo');
      return user;
    }

    async function loadEvents() {
      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('vk_id', currentUser.vk_id)
        .order('event_date', { ascending: true });
      if (error) console.error(error);
      return data || [];
    }

    async function addEvent(title, date) {
      if (!title || !date) return;
      await supabase.from('events').insert([{ vk_id: currentUser.vk_id, title, event_date: date }]);
      render();
    }

    async function deleteEvent(id) {
      await supabase.from('events').delete().eq('id', id);
      render();
    }

    async function updateEvent(id, title, date) {
      await supabase.from('events').update({ title, event_date: date }).eq('id', id);
      render();
    }

    async function render() {
      const events = await loadEvents();

      const app = document.getElementById('root');
      app.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.className = 'vkuiApp';
      wrapper.innerHTML = `
        <div class="vkuiGroup">
          <div class="vkuiPanelHeader">
            <div style="font-size: 20px; font-weight: 600;">Привет, ${currentUser.name}!</div>
          </div>
          <div style="padding: 16px;">
            <input id="title" placeholder="Название события" style="width:100%;margin-bottom:8px;">
            <input id="date" type="date" style="width:100%;margin-bottom:8px;">
            <button id="add" style="width:100%;padding:10px;font-size:17px;">Добавить</button>
          </div>
          <div id="events" style="padding: 10px;"></div>
        </div>
      `;
      app.appendChild(wrapper);

      // Список событий
      const list = wrapper.querySelector('#events');
      if (events.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#666;">Пока нет событий</div>';
      } else {
        events.forEach(ev => {
          const card = document.createElement('div');
          card.style.background = 'white';
          card.style.borderRadius = '10px';
          card.style.padding = '12px';
          card.style.marginBottom = '8px';
          card.style.boxShadow = '0 1px 4px rgba(0,0,0,0.1)';
          card.innerHTML = `
            <div style="font-size:17px;font-weight:500;">${ev.title}</div>
            <div style="font-size:14px;color:#666;margin-bottom:8px;">${new Date(ev.event_date).toLocaleDateString()}</div>
            <div class="event-actions">
              <button class="edit" style="flex:1;background:#ffa500;border:none;color:white;padding:8px;border-radius:8px;">✏️ Редактировать</button>
              <button class="del" style="flex:1;background:#ff5c5c;border:none;color:white;padding:8px;border-radius:8px;">Удалить</button>
            </div>
          `;
          list.appendChild(card);

          card.querySelector('.del').addEventListener('click', () => deleteEvent(ev.id));
          card.querySelector('.edit').addEventListener('click', () => {
            const newTitle = prompt('Новое название:', ev.title);
            const newDate = prompt('Новая дата (YYYY-MM-DD):', ev.event_date);
            if (newTitle && newDate) updateEvent(ev.id, newTitle, newDate);
          });
        });
      }

      // Добавление события
      wrapper.querySelector('#add').addEventListener('click', () => {
        const title = wrapper.querySelector('#title').value.trim();
        const date = wrapper.querySelector('#date').value;
        addEvent(title, date);
      });
    }

    async function main() {
      const vkUser = await initVK();
      currentUser = { vk_id: vkUser.id.toString(), name: vkUser.first_name };
      render();
    }

    main();
  </script>
</body>
</html>
