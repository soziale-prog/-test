<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://inzwlacghhzlzduvvlyb.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluendsYWNnaGh6bHpkdXZ2bHliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNzg2NjEsImV4cCI6MjA3Nzc1NDY2MX0.r7H8cHfQfM9_FZiibCa-J6Gt6yGd4p-FCdS2FsFO3C8'
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  async function initVK() {
    await vkBridge.send('VKWebAppInit')
    const user = await vkBridge.send('VKWebAppGetUserInfo')
    return user
  }

  async function loadUser(vkUser) {
    const vk_id = BigInt(vkUser.id).toString()
    const name = vkUser.first_name

    const { data: existing } = await supabase
      .from('users')
      .select('*')
      .eq('vk_id', vk_id)
      .limit(1)

    if (existing.length > 0) return existing[0]

    const { data: inserted } = await supabase
      .from('users')
      .insert([{ vk_id, name, score: 0 }])
      .select()

    return inserted[0]
  }

  async function updateScore(vk_id, score) {
    const { data } = await supabase
      .from('users')
      .update({ score })
      .eq('vk_id', vk_id)
      .select()
    return data[0]
  }

  let currentUser = null

  async function main() {
    const vkUser = await initVK()
    currentUser = await loadUser(vkUser)
    document.getElementById('status').innerText =
      `Привет, ${currentUser.name}! У тебя ${currentUser.score} очков.`
  }

  async function addPoint() {
    if (!currentUser) return
    currentUser = await updateScore(currentUser.vk_id, currentUser.score + 1)
    document.getElementById('status').innerText =
      `Привет, ${currentUser.name}! У тебя ${currentUser.score} очков.`
  }

  main()
window.addPoint = addPoint; 
</script>